# Pirate Project Rules

This file was originally written for LLMs, but isn't a bad reference for human collaborators.
(Humans can ignore content toward the end of the file.)

## Project Overview

Pirate is a CUDA/C++ pipeline for Fast Radio Burst (FRB) detection, including:
- GPU-accelerated dedispersion kernels
- Python code generators that produce optimized CUDA kernels
- High-level python interface (`pirate_frb` module) via pybind11

Uses the `chord` branch of the ksgpu library for the Array class, and other helpers.
Please complain if you don't see the ksgpu library in the vscode workspace.

## Build System

- Uses pipmake, a tiny build system which is pip-compatible, but forwards pip commands to a Makefile (e.g. `pip install` forwards to `make wheel`).
- The Makefile runs the script `makefile_helper.py,` which contains miscellaneous logic that's more convenient to write in python than in Makefile language. The output of this script is a file `makefile_helper.out`, containing variable declarations in Makefile language.
- Build the whole project with `make -j 32`. Compile time is high, so `make src_lib/FILE.o` may be useful when working on `src_lib/FILE.cu`.
- If you add a new source file, see comments near the top of `Makefile` for instructions on how to modify the makefile.

## File Structure

```
include/pirate/*.hpp          - Public C++ headers
src_lib/*.cu                  - CUDA/C++ implementations
src_lib/autogenerated_kernels/*.cu  - Generated kernels (DO NOT EDIT)
pirate_frb/cuda_generator/*.py      - Python code that generates CUDA kernels
pirate_frb/*.py               - High-level python interface 
bin/                          - Compiled executables
lib/libpirate.so              - Shared library
```

## Autogenerated kernels

 - Source files of the form `src_lib/autogenerated_kernels/*.cu` are autogenerated during the build process, with `python autogenerate_kernel.py src_lib/autogenerated_kernels/FILE.cu`.
 - The script `makefile_helper.py` decides which source files to autogenerate, and writes a list of filenames to `makefile_helper.out`.
 - Individual source files can be generated or compiled with `make src_lib/autogenerated_kernels/filename.{cu,o}`.
 - Each source file "registers" its precompiled kernel at library init time, and the registered kernels are found at runtime. (See examples in `PeakFindingKernel.hpp`.)

## Code Conventions

### Chunks, batches, frames, and segments

Throughout the code:
- A "chunk" (or "time chunk") is a range of time indices. The chunk size (e.g. 1024 or 2048) is defined in `DedispersionConfig::time_samples_per_chunk`.
- A "batch" (or "beam batch") is a range of beam indices. The batch size (e.g. 1,2,4) is defined in `DedispersionConfig::beams_per_batch`.
- A "frame" is a (chunk,beam) pair (not a (chunk,batch) pair!). Frames are used in `class MegaRingbuf`, and will also be used in the front-end server code and its intensity ring buffer.
- A "segment" refers to a 128-byte, memory-contiguous subset of any array in GPU memory. Segments are used in low-level GPU kernels, and data structures which are GPU kernel adjacent (e.g. `DedispersionPlan`, `MegaRingbuf`).

### Low-level building blocks from ksgpu

The following building blocks from the `ksgpu` library are used frequently:
 - `Array<T>` and `Array<void>`: N-dimensional array, on CPU or GPU.
 - `class Dtype`: for types determined dynamically at runtime.
 - `af_*`: memory allocation flags.
 - `xassert*`: assert macros that throw exceptions and print debugging info.
 - Wrapper functions and RAII classes for the cuda library.

If you're reading this, then you should also read `ksgpu/.cursor/rules.md` for
an overview of these building blocks.

### Helper Functions (from pirate/inlines.hpp)
```cpp
xdiv(m, n)              // divide with assertion that n divides m
pow2(n)                 // returns 2^n as long
is_power_of_two(n)      // returns bool
integer_log2(n)         // returns log2 of power-of-two
```

### Style/coding Guidelines

- Prefer explicit types over `auto` (except for iterators and complex template types)
- Prefer private (or static) functions over anonymous scopes `{ ... }`.
- Use `//` comments, not `/* */`
- Document array shapes in comments: `// shape (B, D, M, T)`
- Keep lines under ~120 characters when reasonable
- Use `long` for sizes and indices, not `int` or `size_t`
- Use `uint` (not `unsigned int`) for 32-bit unsigned values
- Use spaces, not tabs.
- Functions which take an `ostream &` argument should not modify stream state in the caller. Save/restore the stream flags/precision if necessary.
- Don't use `using namespace std` or `using namespace ksgpu` in headers.

### Python Interface 

 - C++ classes are exported with pybind11, in `src_pybind11/*.cu`.
 - Python CLI: `python -m pirate_frb test --gddk` runs `GpuDedispersionKernel.test()`.
The `--help` flag shows all available test flags.

### What to do, and not to do

- Please feel free to ask me questions in the chat if my instructions are incomplete.
- Don't edit files in `src_lib/autogenerated_kernels/` - they are generated.
- Don't add features beyond what's requested.
- Don't refactor unrelated code.
- Don't create documentation files unless asked.
- When asked to modify `rules.md`, add new rules, but don't delete existing content.
