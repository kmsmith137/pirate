# Pirate Project Rules

## Project Overview

Pirate is a CUDA/C++ pipeline for Fast Radio Burst (FRB) detection, including:
- GPU-accelerated dedispersion kernels
- Peak-finding algorithms
- Beamforming (CasmBeamformer)
- Python code generators that produce optimized CUDA kernels
- High-level python interface (`pirate_frb` module) via pybind11

Uses the 'chord' branch of the ksgpu library for the Array class and other helpers.
Source code for ksgpu can be found in the cursor workspace (in a "sibling" directory to pirate).
Please complain if you can't see it.

## Build System

- C++17, compiled with nvcc
- Makefile-based build system
- Build with: `make -j 32` (or `make -j 32 lib` for just the library)
- Single source file: `make src_lib/Foo.o`
- Compile time for the whole project is high (a few minutes with 32 threads), so suggest building specific targets.

## File Structure

```
include/pirate/*.hpp          - Public C++ headers
src_lib/*.cu                  - CUDA/C++ implementations
src_lib/autogenerated_kernels/*.cu  - Generated kernels (DO NOT EDIT)
pirate_frb/cuda_generator/*.py      - Python code that generates CUDA kernels
pirate_frb/*.py               - High-level python interface 
bin/                          - Compiled executables
lib/libpirate.so              - Shared library
```

## Autogenerated kernels

 - Around 100 source files of the form `src_lib/autogenerated_kernels/*.cu` are generated during the build process.
 - The Makefile runs the script `makefile_helper.py`, which writes `*.cu` filenames to `makefile_heler.out`. Each file is autogenerated with `python autogenerate_kernel.py filename.cu`.
 - Individual source files can be generated or compiled with `make src_lib/autogenerated_kernels/filename.{cu,o}`.
 - Each source file "registers" its precompiled kernel at library init time (see examples in `PeakFindingKernel.hpp`, and the registered kernels can be found at runtime. 

## Code Conventions

### Types and Sizes
- Use `long` for sizes and indices, not `int` or `size_t`
- Use `uint` (not `unsigned int`) for 32-bit unsigned values
- Arrays use `ksgpu::Array<T>` with shape documented in comments

### Assertions (from ksgpu)
```cpp
xassert(condition);
xassert_eq(a, b);
xassert_ge(a, b);
xassert_le(a, b);
xassert_divisible(m, n);
```

### Helper Functions (from pirate/inlines.hpp)
```cpp
xdiv(m, n)              // divide with assertion that n divides m
pow2(n)                 // returns 2^n as long
is_power_of_two(n)      // returns bool
integer_log2(n)         // returns log2 of power-of-two
```

### CUDA Error Handling
```cpp
CUDA_CALL(cudaMalloc(...));    // throws on error
CUDA_PEEK("kernel_name");       // check for kernel launch errors
```

### Namespace Pattern
```cpp
namespace pirate {
#if 0
}  // editor auto-indent
#endif

// ... code here ...

}  // namespace pirate
```

## External Dependencies

- **ksgpu**: GPU utilities library at `~/git/ksgpu` or via include path
  - `ksgpu::Array<T>` for GPU/CPU arrays
  - `ksgpu::Dtype` for runtime type info
  - `xassert*` macros for assertions

## Style Guidelines

- Prefer explicit types over `auto` (except for iterators and complex template types)
- Use `//` comments, not `/* */`
- Document array shapes in comments: `// shape (B, D, M, T)`
- Keep lines under ~120 characters when reasonable

## Testing Pattern

GPU kernel classes have a static `test()` method:
```cpp
// In header (DedispersionKernel.hpp)
class GpuDedispersionKernel {
    static void test();
};

// In implementation (GpuDedispersionKernel.cu)
namespace {  // anonymous namespace for test helpers
    struct TestHelper { ... };
    static void run_test(...) { ... }
}

void GpuDedispersionKernel::test() {
    TestHelper t;
    t.randomize();
    run_test(t);
}
```

Test helpers go in anonymous namespace to avoid cluttering headers.

## Python Interface (pybind11)

Classes are exported in `src_pybind11/pirate_pybind11.cu`:
```cpp
py::class_<GpuDedispersionKernel>(m, "GpuDedispersionKernel")
    .def_static("test", &GpuDedispersionKernel::test);
```

Python CLI: `python -m pirate_frb test --gddk` runs `GpuDedispersionKernel.test()`.
The `--help` flag shows all available test flags.

## What to do, and not to do

- Please feel free to ask me questions in the slack if my instructions are incomplete
- Don't edit files in `src_lib/autogenerated_kernels/` - they are generated
- Don't add features beyond what's requested
- Don't refactor unrelated code
- Don't create documentation files unless asked
- Don't use `using namespace std` in headers

