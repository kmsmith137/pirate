#!/usr/bin/env python
#
# This script is invoked by the Makefile, to generate "derived" Makefile variables:
#
#   - PYTHON_INCDIR
#   - NUMPY_INCDIR
#   - PYBIND11_INCDIR
#   - PYEXT_SUFFIX
#   - KSGPU_DIR
#   - AUTOGENERATED_KERNELS
#
# Values of these variables are written to makefile_helper.out.


import io
import os
import sys
import sysconfig
import importlib.util

try:
    import pybind11
except:
    raise RuntimeError("Couldn't import pybind11 -- this is a fatal error")

try:
    import numpy
except:
    raise RuntimeError("Couldn't import numpy -- this is a fatal error")


# This way of getting KSGPU_DIR is awkward, but avoids importing 'ksgpu'.
# (This is useful since imports can generate unexpected output.)

ksgpu_spec = importlib.util.find_spec('ksgpu')
if ksgpu_spec is None:
    raise RuntimeError("Couldn't find 'ksgpu' package -- this is a fatal error")

    
# This way of importing 'pirate_frb.cuda generator' doesn't assume that the
# larger 'pirate_frb' package has been built or installed.

sys.path.insert(0, 'pirate_frb')
import cuda_generator


####################################################################################################

        
def generate_kernel_filenames():
    # Dedispersion kernels.
    # To add/remove kernels, you should modify generate_dedispersion_kernels() below.
    for params in generate_dedispersion_kernels():
        yield f'src_lib/autogenerated_kernels/{params.filename}'

    # Peak-finding kernels.
    # To add/remove kernels, you should modify generate_peak_finding_kernels() below.
    for params in generate_peak_finding_kernels():
        yield f'src_lib/autogenerated_kernels/{params.filename}'


def generate_dedispersion_kernels():
    """Generates objects of type 'cuda_generator.DedisperserParams'."""
    
    for dtype in [ 'float', '__half' ]:
        for (irb,orb) in [ (False,False), (True,False), (False,True) ]:  # see below
            for rlag in [ False, True ]:                                 # see below
                for nspec in [ 1 ]:
                    yield cuda_generator.DedisperserParams(
                        dtype = dtype,
                        rank = 1,  # dummy value
                        apply_input_residual_lags = rlag,
                        input_is_ringbuf = irb,
                        output_is_ringbuf = orb,
                        nspec = nspec
                    )

        
def generate_peak_finding_kernels():
    """Generates objects of type 'cuda_generator.PeakFindingParams'."""
    
    for dtype in [ 'float', '__half' ]:
        # Kernels that we're likely to use in CHIME/CHORD without subbanding.
        for M in [1,2,4,8,16]:
            for E in [ (16//M), (32//M) ]:
                yield cuda_generator.PeakFindingParams(dtype, M=M, E=E, Dout=M)
                
        # "Corners" of parameter space
        for M in [1,32]:
            for E in [1,32]:
                for Dout in [1,32]:
                    if (M, E, Dout) == (32, 32, 1):
                        continue  # This one is problematic -- huge compile time.
                    if (M, E, Dout) == (1, 32, 1):
                        continue  # Already included in "CHIME/CHORD" above.
                    yield cuda_generator.PeakFindingParams(dtype, M, E, Dout)

        # These kernels are timed in src_lib/time_gpu_peak_finding_kernels.cu
        yield cuda_generator.PeakFindingParams(dtype, M=16, E=32, Dout=16)
        yield cuda_generator.PeakFindingParams(dtype, M=50, E=32, Dout=16)

        # Testing these kernels (in addition to those above) should cover
        # all code paths in PfReducer.
        for M in range(1,16):
            yield cuda_generator.PeakFindingParams(dtype, M=M, E=32, Dout=16)
            

####################################################################################################


s = io.StringIO()
print("# Autogenerated by makefile_helper.py (which is automatically invoked by the Makefile)\n", file=s)

python_incdir = sysconfig.get_config_var('INCLUDEPY')
print("# Include directory for python headers", file=s)
print("# From sysconfig.get_config_var('INCLUDEPY')", file=s)
print(f"PYTHON_INCDIR = {python_incdir}\n", file=s)

numpy_incdir = numpy.get_include()
print("# Include directory for numpy headers", file=s)
print("# From numpy.get_include()", file=s)
print(f"NUMPY_INCDIR = {numpy_incdir}\n", file=s)

pybind11_incdir = pybind11.get_include()
print("# Include directory for pybind11 headers", file=s)
print("# From pybind11.get_include()", file=s)
print(f"PYBIND11_INCDIR = {pybind11_incdir}\n", file=s)

pyext_suffix = sysconfig.get_config_var('EXT_SUFFIX')
print("# Filename suffix for python extension modules", file=s)
print("# From sysconfig.get_config_var('EXT_SUFFIX')", file=s)
print("# Equivalent to 'python3-config --extension-suffix'", file=s)
print(f"PYEXT_SUFFIX = {pyext_suffix}\n", file=s)

ksgpu_dir = os.path.dirname(ksgpu_spec.origin)
print("# Base directory for 'ksgpu' package", file=s)
print("# From importlib.util.find_spec('ksgpu').origin", file=s)
print(f"KSGPU_DIR = {ksgpu_dir}\n", file=s)

print("# CUDA kernels that will be autogenerated (with ./autogenerate_kernel.py)", file=s)
print('AUTOGENERATED_KERNELS =', end='', file=s)
for k in generate_kernel_filenames():
    print(f' \\\n    {k}', end='', file=s)
print(file=s)

s = s.getvalue()
outfile = 'makefile_helper.out'
print(f'Writing {outfile}')

with open(outfile,'w') as f:
    print(s, file=f, end='')

# Show summary on stdout (for debugging).
if False:
    for line in s.split('\n'):
        if (len(line) > 0) and (line[0] != '#'):
            print('   ', line)
