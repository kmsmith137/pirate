#!/usr/bin/env python
#
# This script is invoked by the Makefile, to generate "derived" Makefile variables:
#
#   - PYTHON_INCDIR
#   - NUMPY_INCDIR
#   - PYBIND11_INCDIR
#   - PYEXT_SUFFIX
#   - KSGPU_DIR
#   - AUTOGENERATED_KERNELS
#
# Values of these variables are written to makefile_helper.out.


import io
import os
import sys
import sysconfig
import importlib.util

try:
    import pybind11
except:
    raise RuntimeError("Couldn't import pybind11 -- this is a fatal error")

try:
    import numpy
except:
    raise RuntimeError("Couldn't import numpy -- this is a fatal error")


# This way of getting KSGPU_DIR is awkward, but avoids importing 'ksgpu'.
# (This is useful since imports can generate unexpected output.)

ksgpu_spec = importlib.util.find_spec('ksgpu')
if ksgpu_spec is None:
    raise RuntimeError("Couldn't find 'ksgpu' package -- this is a fatal error")


####################################################################################################


def generate_peak_finding_kernels():
    """Generates tuples (dtype, M, E, Dout, Dcore, W, BlocksPerSM)."""

    # Debug
    # yield ('fp32', 1, 4, 1, 1, 4, 4)   # (M, E, Dout, Dcore, W, BlocksPerSM)
    # return

    # Generate some kernels with M==Dout. I think these are representative
    # of the non-subband-trigger case.
    
    for M in [ 1, 2, 4, 8, 16, 32 ]:
        for E in [ 1, 2, 4, 8, 16, 32 ]:
            Dout = M
            Dcore = min(Dout, 8)
            W = 4
            BlocksPerSM = 4
            yield ('fp32', M, E, Dout, Dcore, W, BlocksPerSM)

    # Generate some kernels with Dout=16 and large M. I think these will be
    # representative of a future implementation with subband triggers.

    for E in [ 1, 2, 4, 8, 16, 32 ]:
        for M in range(48,53):
            Dout = 16
            Dcore = 8
            W = 4
            BlocksPerSM = 4
            yield ('fp32', M, E, Dout, Dcore, W, BlocksPerSM)
            
        
def generate_kernel_filenames():
    for (dtype, M, E, Dout, Dcore, W, BlocksPerSM) in generate_peak_finding_kernels():
        yield f'src_lib/autogenerated_kernels/pf_{dtype}_M{M}_E{E}_Dout{Dout}_Dcore{Dcore}_W{W}_B{BlocksPerSM}.cu'
    # More autogenerated kernel types will come later
        

####################################################################################################


s = io.StringIO()
print("# Autogenerated by makefile_helper.py (which is automatically invoked by the Makefile)\n", file=s)

python_incdir = sysconfig.get_config_var('INCLUDEPY')
print("# Include directory for python headers", file=s)
print("# From sysconfig.get_config_var('INCLUDEPY')", file=s)
print(f"PYTHON_INCDIR = {python_incdir}\n", file=s)

numpy_incdir = numpy.get_include()
print("# Include directory for numpy headers", file=s)
print("# From numpy.get_include()", file=s)
print(f"NUMPY_INCDIR = {numpy_incdir}\n", file=s)

pybind11_incdir = pybind11.get_include()
print("# Include directory for pybind11 headers", file=s)
print("# From pybind11.get_include()", file=s)
print(f"PYBIND11_INCDIR = {pybind11_incdir}\n", file=s)

pyext_suffix = sysconfig.get_config_var('EXT_SUFFIX')
print("# Filename suffix for python extension modules", file=s)
print("# From sysconfig.get_config_var('EXT_SUFFIX')", file=s)
print("# Equivalent to 'python3-config --extension-suffix'", file=s)
print(f"PYEXT_SUFFIX = {pyext_suffix}\n", file=s)

ksgpu_dir = os.path.dirname(ksgpu_spec.origin)
print("# Base directory for 'ksgpu' package", file=s)
print("# From importlib.util.find_spec('ksgpu').origin", file=s)
print(f"KSGPU_DIR = {ksgpu_dir}\n", file=s)

print("# CUDA kernels that will be autogenerated (with ./autogenerate_kernel.py)", file=s)
print('AUTOGENERATED_KERNELS =', end='', file=s)
for k in generate_kernel_filenames():
    print(f' \\\n    {k}', end='', file=s)
print(file=s)

s = s.getvalue()
outfile = 'makefile_helper.out'
print(f'Writing {outfile}')

with open(outfile,'w') as f:
    print(s, file=f, end='')

# Show summary on stdout (for debugging).
if False:
    for line in s.split('\n'):
        if (len(line) > 0) and (line[0] != '#'):
            print('   ', line)
